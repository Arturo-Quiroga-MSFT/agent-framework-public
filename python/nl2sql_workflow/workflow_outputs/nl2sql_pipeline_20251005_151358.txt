================================================================================
🔍 NL2SQL PIPELINE ANALYSIS REPORT
================================================================================

📋 PIPELINE STAGES:
   1. 🎯 Intent Analysis
   2. 📊 Schema Mapping
   3. 💻 SQL Generation
   4. ✅ Validation
   5. 🔧 Execution
   6. 📝 Results Formatting
================================================================================

────────────────────────────────────────────────────────────────────────────────
💬 STAGE 1: USER QUESTION
────────────────────────────────────────────────────────────────────────────────

what is the schema of the DB

────────────────────────────────────────────────────────────────────────────────
🎯 STAGE 2: INTENT ANALYZER
────────────────────────────────────────────────────────────────────────────────

- Primary intent: SELECT metadata about database structure (schema introspection).
- Entities mentioned: All tables in the database along with their columns (table names and column names/types).
- Conditions/filters requested: None; request is for comprehensive schema details.
- Required aggregations or calculations: None.
- Expected output format: List or table detailing each table's name and its corresponding columns (including data types, if possible). Could be presented as grouped information per table.

────────────────────────────────────────────────────────────────────────────────
📊 STAGE 3: SCHEMA EXPERT
────────────────────────────────────────────────────────────────────────────────

Schema Mapping for “what is the schema of the DB”:

1. **Relevant Tables Needed**: Use SQL Server system catalog views:  
   - `INFORMATION_SCHEMA.TABLES` (lists tables)  
   - `INFORMATION_SCHEMA.COLUMNS` (lists columns for each table)
2. **Specific Columns to Query**:  
   - From `INFORMATION_SCHEMA.TABLES`: `TABLE_SCHEMA`, `TABLE_NAME`  
   - From `INFORMATION_SCHEMA.COLUMNS`: `COLUMN_NAME`, `DATA_TYPE`, `IS_NULLABLE`, `CHARACTER_MAXIMUM_LENGTH` (etc.)
3. **JOIN Relationships Required**:  
   - Join `TABLES` and `COLUMNS` using `TABLE_SCHEMA` and `TABLE_NAME` to group columns by each table.
4. **Indexes that Could Help Performance**:  
   - System catalog views are optimized for metadata; indexes not needed here.
5. **Potential Schema Limitations**:  
   - Extended properties (comments/descriptions) are not included unless specifically queried; output will be limited to structural metadata (names, types, nullability).

**Summary:**  
- Query the system catalog views for all tables and all columns, including data types, nullability, and character length, grouped by table for a full schema dump.  
- No user table joins, filters, or custom indexes required.

────────────────────────────────────────────────────────────────────────────────
💻 STAGE 4: SQL GENERATOR
────────────────────────────────────────────────────────────────────────────────

```sql
-- Show the full schema of the current database: each table and its columns with details.
-- Uses INFORMATION_SCHEMA views for compatibility and best practice.

SELECT
    t.TABLE_SCHEMA,
    t.TABLE_NAME,
    c.COLUMN_NAME,
    c.DATA_TYPE,
    c.IS_NULLABLE,
    c.CHARACTER_MAXIMUM_LENGTH
FROM
    INFORMATION_SCHEMA.TABLES t
INNER JOIN
    INFORMATION_SCHEMA.COLUMNS c
    ON t.TABLE_SCHEMA = c.TABLE_SCHEMA
    AND t.TABLE_NAME = c.TABLE_NAME
WHERE
    t.TABLE_TYPE = 'BASE TABLE'
ORDER BY
    t.TABLE_SCHEMA, t.TABLE_NAME, c.ORDINAL_POSITION;

-- Key comments:
-- 1. Lists every user table with all columns and descriptions (name, type, nullability, length).
-- 2. Ordered for legibility: by schema, table, and column order in each table.
-- 3. Uses INNER JOIN to combine table and column info in one output for easy schema browsing.
-- 4. Does not display system or view definitions—only base user tables.
```

────────────────────────────────────────────────────────────────────────────────
✅ STAGE 5: SQL VALIDATOR
────────────────────────────────────────────────────────────────────────────────

```sql
SELECT 
    t.TABLE_SCHEMA,
    t.TABLE_NAME,
    c.COLUMN_NAME,
    c.DATA_TYPE,
    c.IS_NULLABLE,
    c.CHARACTER_MAXIMUM_LENGTH
FROM 
    INFORMATION_SCHEMA.TABLES t
INNER JOIN 
    INFORMATION_SCHEMA.COLUMNS c
    ON t.TABLE_SCHEMA = c.TABLE_SCHEMA
    AND t.TABLE_NAME = c.TABLE_NAME
WHERE 
    t.TABLE_TYPE = 'BASE TABLE'
ORDER BY 
    t.TABLE_SCHEMA, t.TABLE_NAME, c.ORDINAL_POSITION
```
This will give you the schema: every table, and for each table, its columns, type, nullability, and length.

────────────────────────────────────────────────────────────────────────────────
🔧 STAGE 6: QUERY EXECUTOR
────────────────────────────────────────────────────────────────────────────────


🔧 SQL QUERY EXECUTED:

```sql
SELECT 
    t.TABLE_SCHEMA,
    t.TABLE_NAME,
    c.COLUMN_NAME,
    c.DATA_TYPE,
    c.IS_NULLABLE,
    c.CHARACTER_MAXIMUM_LENGTH
FROM 
    INFORMATION_SCHEMA.TABLES t
INNER JOIN 
    INFORMATION_SCHEMA.COLUMNS c
    ON t.TABLE_SCHEMA = c.TABLE_SCHEMA
    AND t.TABLE_NAME = c.TABLE_NAME
WHERE 
    t.TABLE_TYPE = 'BASE TABLE'
ORDER BY 
    t.TABLE_SCHEMA, t.TABLE_NAME, c.ORDINAL_POSITION
```


✅ Query executed successfully. Returned 100 row(s):

────────────────────────────────────────────────────────────────────────────────
TABLE_SCHEMA         | TABLE_NAME           | COLUMN_NAME          | DATA_TYPE            | IS_NULLABLE          | CHARACTER_MAXIMUM_LE
────────────────────────────────────────────────────────────────────────────────
dbo                  | Collateral           | CollateralId         | bigint               | NO                   | NULL                
dbo                  | Collateral           | LoanId               | bigint               | NO                   | NULL                
dbo                  | Collateral           | CollateralType       | varchar              | NO                   | 30                  
dbo                  | Collateral           | Description          | nvarchar             | YES                  | 200                 
dbo                  | Collateral           | Jurisdiction         | nvarchar             | YES                  | 100                 
dbo                  | Collateral           | ValueAmount          | decimal              | NO                   | NULL                
dbo                  | Collateral           | CurrencyCode         | char                 | NO                   | 3                   
dbo                  | Collateral           | ValuationDate        | date                 | NO                   | NULL                
dbo                  | Collateral           | Status               | varchar              | NO                   | 20                  
dbo                  | Company              | CompanyId            | bigint               | NO                   | NULL                
dbo                  | Company              | CompanyName          | nvarchar             | NO                   | 200                 
dbo                  | Company              | CountryCode          | char                 | NO                   | 2                   
dbo                  | Company              | Industry             | nvarchar             | YES                  | 100                 
dbo                  | Company              | CreditRating         | varchar              | YES                  | 8                   
dbo                  | Company              | FoundedYear          | smallint             | YES                  | NULL                
dbo                  | Company              | EmployeeCount        | int                  | YES                  | NULL                
dbo                  | CompanyAddress       | AddressId            | bigint               | NO                   | NULL                
dbo                  | CompanyAddress       | CompanyId            | bigint               | NO                   | NULL                
dbo                  | CompanyAddress       | AddressType          | varchar              | NO                   | 20                  
dbo                  | CompanyAddress       | Line1                | nvarchar             | YES                  | 200                 
dbo                  | CompanyAddress       | City                 | nvarchar             | YES                  | 100                 
dbo                  | CompanyAddress       | StateProvince        | nvarchar             | YES                  | 100                 
dbo                  | CompanyAddress       | PostalCode           | nvarchar             | YES                  | 20                  
dbo                  | CompanyAddress       | CountryCode          | char                 | NO                   | 2                   
dbo                  | CompanyAddress       | Latitude             | decimal              | YES                  | NULL                
dbo                  | CompanyAddress       | Longitude            | decimal              | YES                  | NULL                
dbo                  | CompanyAddress       | EffectiveDate        | date                 | YES                  | NULL                
dbo                  | Covenant             | CovenantId           | bigint               | NO                   | NULL                
dbo                  | Covenant             | LoanId               | bigint               | NO                   | NULL                
dbo                  | Covenant             | CovenantType         | varchar              | NO                   | 40                  
dbo                  | Covenant             | Operator             | varchar              | NO                   | 2                   
dbo                  | Covenant             | Threshold            | decimal              | NO                   | NULL                
dbo                  | Covenant             | Frequency            | varchar              | NO                   | 20                  
dbo                  | Covenant             | LastTestDate         | date                 | YES                  | NULL                
dbo                  | Covenant             | Status               | varchar              | NO                   | 20                  
dbo                  | Covenant             | Notes                | nvarchar             | YES                  | 200                 
dbo                  | CovenantSchedule     | CovenantScheduleId   | bigint               | NO                   | NULL                
dbo                  | CovenantSchedule     | CovenantId           | bigint               | NO                   | NULL                
dbo                  | CovenantSchedule     | TestDueDate          | date                 | NO                   | NULL                
dbo                  | CovenantSchedule     | RequiredOperator     | varchar              | YES                  | 5                   
dbo                  | CovenantSchedule     | RequiredThreshold    | decimal              | YES                  | NULL                
dbo                  | CovenantSchedule     | NotificationDays     | smallint             | YES                  | NULL                
dbo                  | CovenantTestResult   | TestResultId         | bigint               | NO                   | NULL                
dbo                  | CovenantTestResult   | CovenantId           | bigint               | NO                   | NULL                
dbo                  | CovenantTestResult   | LoanId               | bigint               | NO                   | NULL                
dbo                  | CovenantTestResult   | TestDate             | date                 | NO                   | NULL                
dbo                  | CovenantTestResult   | Status               | varchar              | NO                   | 20                  
dbo                  | CovenantTestResult   | ObservedValue        | decimal              | YES                  | NULL                
dbo                  | CovenantTestResult   | Notes                | nvarchar             | YES                  | 200                 
dbo                  | CustomerProfile      | CustomerProfileId    | bigint               | NO                   | NULL                
dbo                  | CustomerProfile      | CompanyId            | bigint               | NO                   | NULL                
dbo                  | CustomerProfile      | LegalName            | nvarchar             | NO                   | 200                 
dbo                  | CustomerProfile      | TaxId                | nvarchar             | YES                  | 50                  
dbo                  | CustomerProfile      | ParentCompanyId      | bigint               | YES                  | NULL                
dbo                  | CustomerProfile      | OwnershipType        | nvarchar             | YES                  | 50                  
dbo                  | CustomerProfile      | ESGScore             | decimal              | YES                  | NULL                
dbo                  | CustomerProfile      | AnnualRevenueUSD     | decimal              | YES                  | NULL                
dbo                  | CustomerProfile      | Headcount            | int                  | YES                  | NULL                
dbo                  | CustomerProfile      | Website              | nvarchar             | YES                  | 200                 
dbo                  | CustomerProfile      | IncorporationDate    | date                 | YES                  | NULL                
dbo                  | CustomerProfile      | CreditOfficer        | nvarchar             | YES                  | 100                 
dbo                  | CustomerProfile      | RiskAppetite         | nvarchar             | YES                  | 50                  
dbo                  | db_assistant_migrati | hash                 | varchar              | NO                   | 64                  
dbo                  | db_assistant_migrati | file_name            | nvarchar             | YES                  | 400                 
dbo                  | db_assistant_migrati | applied_utc          | datetime2            | NO                   | NULL                
dbo                  | dim_company          | company_key          | int                  | NO                   | NULL                
dbo                  | dim_company          | company_id           | varchar              | NO                   | 50                  
dbo                  | dim_company          | region               | varchar              | NO                   | 40                  
dbo                  | dim_company          | industry             | varchar              | YES                  | 60                  
dbo                  | dim_date             | date_key             | int                  | NO                   | NULL                
dbo                  | dim_date             | calendar_date        | date                 | NO                   | NULL                
dbo                  | fact_loan_payments   | loan_id              | varchar              | NO                   | 50                  
dbo                  | fact_loan_payments   | principal_paid       | decimal              | NO                   | NULL                
dbo                  | fact_loan_payments   | interest_paid        | decimal              | NO                   | NULL                
dbo                  | fact_loan_payments   | company_key          | int                  | NO                   | NULL                
dbo                  | fact_loan_payments   | date_key             | int                  | NO                   | NULL                
dbo                  | Loan                 | LoanId               | bigint               | NO                   | NULL                
dbo                  | Loan                 | CompanyId            | bigint               | NO                   | NULL                
dbo                  | Loan                 | LoanNumber           | varchar              | NO                   | 40                  
dbo                  | Loan                 | OriginationDate      | date                 | NO                   | NULL                
dbo                  | Loan                 | MaturityDate         | date                 | NO                   | NULL                
dbo                  | Loan                 | PrincipalAmount      | decimal              | NO                   | NULL                
dbo                  | Loan                 | CurrencyCode         | char                 | NO                   | 3                   
dbo                  | Loan                 | InterestRatePct      | decimal              | NO                   | NULL                
dbo                  | Loan                 | InterestRateType     | varchar              | NO                   | 20                  
dbo                  | Loan                 | ReferenceRate        | varchar              | YES                  | 20                  
dbo                  | Loan                 | SpreadBps            | smallint             | YES                  | NULL                
dbo                  | Loan                 | AmortizationType     | varchar              | NO                   | 20                  
dbo                  | Loan                 | PaymentFreqMonths    | tinyint              | NO                   | NULL                
dbo                  | Loan                 | Purpose              | nvarchar             | YES                  | 200                 
dbo                  | Loan                 | Status               | varchar              | NO                   | 20                  
dbo                  | Loan                 | ReferenceRateCode    | varchar              | YES                  | 20                  
dbo                  | LoanDelinquencyFeatu | loan_id              | bigint               | NO                   | NULL                
dbo                  | LoanDelinquencyFeatu | company_id           | bigint               | YES                  | NULL                
dbo                  | LoanDelinquencyFeatu | snapshot_date        | date                 | NO                   | NULL                
dbo                  | LoanDelinquencyFeatu | loan_age_days        | int                  | YES                  | NULL                
dbo                  | LoanDelinquencyFeatu | days_to_maturity     | int                  | YES                  | NULL                
dbo                  | LoanDelinquencyFeatu | principal_amount     | decimal              | YES                  | NULL                
dbo                  | LoanDelinquencyFeatu | interest_rate_pct    | decimal              | YES                  | NULL                
dbo                  | LoanDelinquencyFeatu | payment_freq_months  | tinyint              | YES                  | NULL                
────────────────────────────────────────────────────────────────────────────────

⚠️ Results limited to 100 rows. More data may exist.

────────────────────────────────────────────────────────────────────────────────
📝 STAGE 7: RESULTS FORMATTER
────────────────────────────────────────────────────────────────────────────────

### 1. What was requested?
You asked: **"What is the schema of the database?"**  
This means you wanted to see all tables in the database along with their columns and their data types.

---

### 2. What did the SQL query do?
The SQL query inspected the system metadata tables (`INFORMATION_SCHEMA.TABLES` and `INFORMATION_SCHEMA.COLUMNS`) to list every user table in the database, plus each column’s name, data type, and details like whether the column can be null and its maximum length.

---

### 3. Actual results (sample view)

| TABLE_SCHEMA | TABLE_NAME               | COLUMN_NAME         | DATA_TYPE | IS_NULLABLE | CHARACTER_MAXIMUM_LENGTH |
|--------------|-------------------------|---------------------|-----------|-------------|-------------------------|
| dbo          | Collateral              | CollateralId        | bigint    | NO          | NULL                    |
| dbo          | Collateral              | LoanId              | bigint    | NO          | NULL                    |
| dbo          | Collateral              | CollateralType      | varchar   | NO          | 30                      |
| dbo          | Company                 | CompanyId           | bigint    | NO          | NULL                    |
| dbo          | Company                 | CompanyName         | nvarchar  | NO          | 200                     |
| dbo          | Covenant                | CovenantId          | bigint    | NO          | NULL                    |
| dbo          | Loan                    | LoanId              | bigint    | NO          | NULL                    |
| dbo          | Loan                    | CompanyId           | bigint    | NO          | NULL                    |
| dbo          | CustomerProfile         | CustomerProfileId   | bigint    | NO          | NULL                    |
| ...more rows below...|

(***Note:** The results showed 100 rows as a sample, and more may exist in the schema.)

Key tables in your schema include:  
- **Collateral**
- **Company**
- **CompanyAddress**
- **Covenant**
- **CovenantSchedule**
- **CovenantTestResult**
- **CustomerProfile**
- **Loan**
- **LoanDelinquencyFeature**
- **fact_loan_payments**
- **dim_company**
- **dim_date**
- Other system or migration tables

Each table’s columns are listed with their names, data types, if they can be null, and size for string values.

---

### 4. Business insights & recommendations

- **The database has a rich structure for financial, loan, covenant, company, and profile management.**
- **Fact** and **dim** tables suggest a data warehouse component, enabling analytics and reporting.
- **Nullable columns** highlight potential areas to enforce additional data integrity, depending on business needs.
- Some tables (e.g., "Loan," "CustomerProfile") appear central and may serve as main linkage points between business entities.

**Recommendation:**  
Consider documenting relationships (primary/foreign keys) more explicitly for future data modeling, onboarding, or integration purposes. If you have reporting or new feature needs, these core tables are likely involved.

---

### 5. Limitations or caveats

- **Only the first 100 rows were shown.** If you have more tables or columns, they weren’t included in this preview.
- **No relationship (foreign key) information** was included—just structure, not how tables link.
- **No column comments/descriptions** were shown.
**If you need the full output or want to see table relationships or constraints, let us know!**

================================================================================
✅ NL2SQL Pipeline Complete - All 6 Stages Executed
================================================================================
- **View** definitions and system tables were excluded (only base tables are included).
